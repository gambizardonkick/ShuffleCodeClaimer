# Deploying to Render.com

This guide will help you deploy your Shuffle Code Claimer application to Render.

## Prerequisites

1. **GitHub Account** - Your code must be in a GitHub repository
2. **Render Account** - Sign up at https://render.com
3. **Firebase Account** - Your Firebase Realtime Database credentials
4. **Telegram Bot Tokens** - Your bot tokens and API credentials
5. **OxaPay Account** - Your payment gateway credentials

## Project Structure

This project consists of 3 services:
- **API Server** (Web Service) - Main API on port 10000
- **Subscription Bot** (Background Worker) - Handles subscriptions
- **Telegram Client** (Background Worker) - Monitors Telegram groups

## Deployment Methods

### Method 1: Using render.yaml (Recommended)

1. **Push to GitHub**
   ```bash
   git add .
   git commit -m "Prepare for Render deployment"
   git push origin main
   ```

2. **Create New Blueprint on Render**
   - Go to https://dashboard.render.com/blueprints
   - Click "New Blueprint Instance"
   - Connect your GitHub repository
   - Render will automatically detect the `render.yaml` file
   - Click "Apply"

3. **Configure Environment Variables**
   
   For each service, Render will prompt you to add these environment variables:

   **Required for All Services:**
   - `FIREBASE_PROJECT_ID` - Your Firebase project ID
   - `FIREBASE_CLIENT_EMAIL` - Your Firebase service account email
   - `FIREBASE_PRIVATE_KEY` - Your Firebase private key (keep the \n characters)
   - `FIREBASE_DATABASE_URL` - Your Firebase database URL
   - `SUBSCRIPTION_BOT_TOKEN` - Your subscription bot token

   **API Server Only:**
   - `JWT_SECRET` - Auto-generated by Render
   - `OXAPAY_API_KEY` - Your OxaPay API key
   - `OXAPAY_MERCHANT_API_KEY` - Your OxaPay merchant key

   **Telegram Client Only:**
   - `TELEGRAM_API_ID` - Your Telegram API ID
   - `TELEGRAM_API_HASH` - Your Telegram API hash
   - `TELEGRAM_SESSION_STRING` - Your session string

4. **Deploy**
   - Click "Create Blueprint"
   - All 3 services will deploy automatically

### Method 2: Manual Deployment

#### Step 1: Deploy API Server

1. Go to https://dashboard.render.com
2. Click "New +" → "Web Service"
3. Connect your GitHub repository
4. Configure:
   - **Name:** shuffle-api-server
   - **Environment:** Node
   - **Region:** Oregon (or your preferred region)
   - **Branch:** main
   - **Build Command:** `npm install`
   - **Start Command:** `npm run api`
   - **Plan:** Free

5. Add Environment Variables (see list above)

6. Click "Create Web Service"

#### Step 2: Deploy Subscription Bot

1. Click "New +" → "Background Worker"
2. Connect your GitHub repository
3. Configure:
   - **Name:** shuffle-subscription-bot
   - **Environment:** Node
   - **Branch:** main
   - **Build Command:** `npm install`
   - **Start Command:** `npm run subscription-bot`
   - **Plan:** Free

4. Add Environment Variables

5. Click "Create Worker"

#### Step 3: Deploy Telegram Client

1. Click "New +" → "Background Worker"
2. Connect your GitHub repository
3. Configure:
   - **Name:** shuffle-telegram-bot
   - **Environment:** Node
   - **Branch:** main
   - **Build Command:** `npm install`
   - **Start Command:** `npm run telegram-bot`
   - **Plan:** Free

4. Add Environment Variables

5. Click "Create Worker"

## Important Notes

### Port Configuration
- Render automatically assigns port via `process.env.PORT`
- Your API server is already configured correctly
- Don't hardcode ports in your code

### Firebase Private Key
When adding `FIREBASE_PRIVATE_KEY`, make sure to:
- Keep all `\n` characters in the key
- Or paste the entire key including line breaks
- Quote the value if using command line

### Free Tier Limitations
- Services spin down after 15 minutes of inactivity
- First request after sleep may take 30-60 seconds
- 750 hours/month free (shared across all services)
- Background workers count toward this limit

### Auto-Deploy
- Render automatically deploys when you push to GitHub
- You can disable this in service settings if needed

### Health Checks
- The API server includes a `/health` endpoint
- Render uses this to monitor service health
- Add one to your server if it doesn't exist:

```javascript
app.get('/health', (req, res) => {
  res.status(200).json({ status: 'ok' });
});
```

## Monitoring & Logs

### View Logs
1. Go to your service dashboard
2. Click "Logs" tab
3. View real-time logs

### Check Service Status
- Green = Running
- Yellow = Deploying
- Red = Failed

### Restart Services
- Click service → "Manual Deploy" → "Deploy latest commit"

## Troubleshooting

### Build Failures
- Check that all dependencies are in `package.json`
- Verify Node version is compatible (20.x)
- Check build logs for specific errors

### Runtime Errors
- Verify all environment variables are set correctly
- Check service logs for error messages
- Ensure Firebase credentials are valid

### Connection Issues
- Make sure CORS is enabled for your domain
- Check that the correct PORT is being used
- Verify webhook URLs point to your Render domain

## Getting Your Render URL

After deployment, your API server will be available at:
```
https://shuffle-api-server.onrender.com
```

Update this URL in:
1. Your Tampermonkey script (`ShuffleCodeClaimer.user.js`)
2. OxaPay webhook configuration
3. Any frontend applications

## Database Setup

This project uses Firebase Realtime Database:
1. Create database in Firebase Console
2. Set up indexes as mentioned in Firebase warnings
3. Add security rules
4. Copy connection details to Render environment variables

## Updating Your Application

1. Make changes to your code
2. Commit and push to GitHub:
   ```bash
   git add .
   git commit -m "Your update message"
   git push origin main
   ```
3. Render automatically deploys the changes
4. Monitor deployment in Render dashboard

## Cost Optimization

### Free Tier Tips
- Use Render for API and background workers
- Keep Firebase on free tier (Spark plan)
- Monitor usage to stay within limits

### Scaling Up
When you outgrow the free tier:
- Upgrade to Starter plan ($7/month per service)
- Services stay awake 24/7
- Better performance and reliability

## Support

- Render Docs: https://render.com/docs
- Render Community: https://community.render.com
- Firebase Docs: https://firebase.google.com/docs

## Security Checklist

- [ ] All secrets stored as environment variables
- [ ] `.env` file in `.gitignore`
- [ ] Firebase security rules configured
- [ ] OxaPay webhook signature verification enabled
- [ ] JWT_SECRET is strong and unique
- [ ] HTTPS only (Render provides this automatically)
